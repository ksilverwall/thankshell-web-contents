<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SLA Wallet</title>
    <link rel="shortcut icon" href="groups/sla/selan.ico" type="image/vnd.microsoft.icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </head>
  <body>
    <div class="container-fluid bg-info">
      <div class="row">
          <p id="message" class="col-12" style="background-color: #ffa500"></p>
      </div>
      <div class="row">
          <div class="col">ID: <span id="user-name">---</span></div>
      </div>
      <div class="row">
          <div class="col">Facebook連携</div>
          <div class="col-3"><button id="linkFacebook" class="btn btn-primary" disabled>連携する</button></div>
          <div class="col-3"><button id="unlinkFacebook" class="btn btn-primary" disabled>解除する</button></div>
      </div>
      <div class="row"></div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.263.1.min.js"></script>
    <script src="/js/aws-cognito-sdk.min.js"></script>
    <script src="/js/amazon-cognito-identity.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/bank.js"></script>

    <script type="text/javascript" src="/js/amazon-cognito-auth.min.js"></script>


    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '366917974106989',
          cookie     : true,
          xfbml      : true,
          version    : 'v3.2'
        });

        FB.AppEvents.logPageView();

      };

      (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));

      let getSession = (callback) => {
          let controller = new SessionController();
          let auth = controller.auth;

          if(auth.isUserSignedIn()) {
              console.log(auth.getCurrentUser());
              auth.userhandler = {
                onSuccess: callback,
                onFailure: function(err) {
                  console.log("Error!");
                  console.log(err);
                }
              };

              auth.getSession();
          } else {
              console.log("User is not signed in");
              location.href='/';
          }
      }

      updateButtonStatus = async(session) => {
          let response = await fetch('https://api.thankshell.com/dev/user/link', {
              method: "GET",
              headers: {
                  "Content-Type": "application/json; charset=utf-8",
                  Authorization: session.idToken.jwtToken
              },
          });

          let links = await response.json();

          if (links.filter(e => e['auth_id'].startsWith('Facebook')).length > 0) {
              $("#linkFacebook").prop("disabled", true);
              $("#unlinkFacebook").prop("disabled", false);
          } else {
              $("#linkFacebook").prop("disabled", false);
              $("#unlinkFacebook").prop("disabled", true);
          }
      };

      getSession(async(session) => {
          let userInfo = await (await fetch('https://api.thankshell.com/dev/user/', {
              method: "GET",
              headers: {
                  "Content-Type": "application/json; charset=utf-8",
                  Authorization: session.idToken.jwtToken
              },
          })).json();

          if (userInfo.code == "SUCCESS") {
              $("#user-name").text(userInfo.name ? userInfo.name : '---');
          } else {
              // TODO implement here
          }

          updateButtonStatus(session);

          $('#unlinkFacebook').click(async()=>{
              $('#unlinkFacebook').prop("disabled", true);
              FB.getLoginStatus(async(response)=>{
                  try {
                      let response2 = await fetch('https://api.thankshell.com/dev/user/link/Facebook', {
                          method: "DELETE",
                          headers: {
                              "Content-Type": "application/json; charset=utf-8",
                              Authorization: session.idToken.jwtToken
                          },
                          body: JSON.stringify({
                              'id': response.authResponse.userID,
                              'token': response.authResponse.accessToken,
                          }),
                      });

                      if (response2.status !== 200) {
                          let result = await response2.json();
                          $('#message').text(result.message);
                      }
                  } catch(e) {
                      $('#message').text(e.message);
                  } finally {
                      updateButtonStatus(session);
                  }
              });
          });

          $('#linkFacebook').click(async()=>{
              $('#linkFacebook').prop("disabled", true);
              FB.getLoginStatus(async(response)=>{
                  try {
                      let response2 = await fetch('https://api.thankshell.com/dev/user/link/Facebook', {
                          method: "PUT",
                          headers: {
                              "Content-Type": "application/json; charset=utf-8",
                              Authorization: session.idToken.jwtToken
                          },
                          body: JSON.stringify({
                              'id': response.authResponse.userID,
                              'token': response.authResponse.accessToken,
                          }),
                      });

                      if (response2.status !== 200) {
                          let result = await response2.json();
                          $('#message').text(result.message);
                      }
                  } catch (e){
                      $('#message').text(e.message); 
                      console.log(e);
                  } finally {
                      updateButtonStatus(session);
                  }
              });
          });
     });

    </script>
  </body>
</html>
