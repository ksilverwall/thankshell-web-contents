<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SLA Bank Manager</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.18/css/dataTables.bootstrap4.min.css"/>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">SLA Bank Manager</a>
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="https://sketch-life-academy.com/selan-help/">ヘルプ</a>
        </li>
      </ul>
      <form class="form-inline my-2 my-lg-0">
        <label><span id='user-name'>---</span> さん</label>
        <button type="submit" id="logoutButton" class="btn btn-outline-success my-2 my-sm-0">ログアウト</button>
      </form>
    </nav>

    <div class="row">
      <div class="col">
        <h4 class="text-right">総発行量 <u><span id=published>---</span> Selan</u></h4>
        <h4 class="text-right">銀行保有量 <u><span id=carried>---</span> Selan</u></h4>
        <h4 class="text-right">流通量 <u><span id=currency>---</span> Selan</u></h4>
      </div>
    </div>

    <div id='admin-only' class="container-fluid" style='display:none'>
      <h1>管理フォーム</h1>

      <div class="card bg-light mb-3" style="max-width: 40rem;">
        <div class="card-header">
	      <h4>Selanを増刷する</h4>
        </div>
        <div class="card-body">
          <form id='publish'>
            <div class="form-group">
              <input id='publish-amount'class="form-control text-right" type="number" name="amount" min="1000" value="1000" />
              <input id='publish-button' class="btn btn-primary" type="button" value="新規発行" />
            </div>
          </form>
          <br/>
          <p class="text-center text-danger" id="publish-message">削除未実装のためご注意ください</p>
        </div>
      </div>

      <div class="card bg-warning mb-3" style="max-width: 40rem;">
        <div class="card-header">
	      <h4>ユーザー(未実装)</h4>
        </div>
        <div class="card-body">
          <a href='https://ap-northeast-1.console.aws.amazon.com/cognito/users/?region=ap-northeast-1#/pool/ap-northeast-1_WEGpvJz9M/details?_k=xuxjha'>ユーザー管理画面(Amazon Cognito)</a>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
	      <h4>Selanを送る</h4>
        </div>
        <div class="card-body">
          <form class="form-horizontal" id="send-selan">
            <div class="row">
              <div class="col form-group">
                <label>送金先</label>
                <input class="form-control" type="text" name="to_account" />
              </div>
              <div class="col form-group">
                <label>金額</label>
                <input class="form-control" type="number" min="1" name="amount" value='1000'/>
              </div>
              <div class="col form-group">
                <label>コメント</label>
                <input class="form-control" type="text" name="comment"/>
              </div>
            </div>
            <div class="row">
              <div class="col-5">
              </div>
              <div class="col-2">
                <input id='send-selan-button' class="btn-block btn-primary" type="button" value="送金" />
              </div>
              <div class="col-5">
              </div>
            </div>
          </form>
          <br/>
          <p class="text-center text-danger" id="send-selan-message">送金後の取り消しはできませんのでご注意ください</p>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h4>保有状況</h4>
        </div>
        <div class="card-body">
          <p class="text-center text-danger" id="history-message"></p>
          <table id='account-info' class="table mb-0">
            <thead>
              <tr>
                <th scope="col" class="text-left">アカウント</th>
                <th scope="col" class="text-left">ステータス</th>
                <th scope="col" class="text-right">金額(selan)</th>
              </tr>
            </thead>
            <tbody id="carried-list">
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h4>取引履歴</h4>
        </div>
        <div class="card-body">
          <p class="text-center text-danger" id="history-message"></p>
          <table id="transaction-list" class="table mb-0">
            <thead>
              <tr>
                <th scope="col" class="text-right">取引ID</th>
                <th scope="col">取引日時</th>
                <th scope="col">FROM</th>
                <th scope="col">TO</th>
                <th scope="col" class="text-right">金額(selan)</th>
                <th scope="col" class="text-left">コメント</th>
              </tr>
            </thead>
            <tbody id="history">
            </tbody>
          </table>
        </div>
      </div>

      <div class="row"></div>
   </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.224.1.min.js"></script>
    <script src="/js/aws-cognito-sdk.min.js"></script>
    <script src="/js/amazon-cognito-identity.min.js"></script>
    <script src="/js/amazon-cognito-auth.min.js"></script>
    <script src="/js/bank.js"></script>
    <script src="/js/auth.js"></script>

    <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="//cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>

    <script>
    $('#logoutButton').click(()=>(new SessionController()).close());

    let publish = async() => {
        (new SessionController()).get(async(session) => {
            let data = {};
            $('#publish').find('input').each((index, input) => {
                if(input.name){
                    data[input.name] = input.value;
                }
            });
            data['from_account'] = '--';
            data['to_account'] = 'sla_bank';

            $('#publish-message').text('発行中');

            try {
                let response = await fetch('https://api.thankshell.com/dev/token/selan/published', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                        Authorization: session.idToken.jwtToken
                    },
                    body: JSON.stringify({
                        to: 'sla_bank',
                        amount: data['amount'],
                    }),
                });
                $('#publish-message').text('発行しました');
            } catch(e) {
                $('#publish-message').text('ERROR: ' + e.message);
            }
        });
    };

    let sendSelan = async() => {
        // TODO should be promise
        (new SessionController()).get(async(session) => {
            if($('#send-selan-button').prop("disabled")) {
                return;
            }

            let response = await fetch('https://api.thankshell.com/dev/user/', {
                method: "GET",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                    Authorization: session.idToken.jwtToken
                },
            });
            let userInfo = await response.json();

            let data = {};
            $('#send-selan').find('input').each((index, input) => {
                if(input.name){
                    data[input.name] = input.value;
                }
            });
            data['from'] = 'sla_bank';

            $('#send-selan-button').prop("disabled", true);
            $('#send-selan-button').addClass("disabled");
            $('#send-selan-message').text('送金中');

            try {
                await createTransaction(data, session);
                // FIXME
                await loadTransactions(session);
                $('#send-selan-message').text('送金が完了しました');
            } catch(e) {
                $('#send-selan-message').text('ERROR: ' + e.message);
            }

            $('#send-selan-button').prop("disabled", false);
            $('#send-selan-button').removeClass("disabled");
        });
    };

    let createTransaction = async(data, session) => {
        let response = await fetch('https://api.thankshell.com/dev/token/selan/transactions', {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                Authorization: session.idToken.jwtToken
            },
            body: JSON.stringify(data),
        });

        if (response.status !== 200) {
            let data = await response.json();
            throw new Error(data.message);
        }
    };

    let getHolding = async(userId, session) => {
        let response = await fetch('https://api.thankshell.com/dev/token/selan/holders', {
            method: "GET",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                Authorization: session.idToken.jwtToken
            },
        });

        return await response.json();
    };

    let getPublished = async(session) => {
        let response1 = await fetch('https://api.thankshell.com/dev/token/selan/published', {
            method: "GET",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                Authorization: session.idToken.jwtToken
            },
        });

        return published = await response1.json();
    };

    let getCarriedList = async(userId, session) => {
        let response2 = await fetch('https://api.thankshell.com/dev/token/selan/transactions', {
            method: "GET",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                Authorization: session.idToken.jwtToken
            },
        });
        let data = await response2.json();

        //return data.bank.account;
        return null;

    };

    let loadTransactions = async(userId, session) => {
        let response2 = await fetch('https://api.thankshell.com/dev/token/selan/transactions', {
            method: "GET",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                Authorization: session.idToken.jwtToken
            },
        });
        let data = await response2.json();

        return data.history.Items;
    };

    (new SessionController()).get(async(session) => {
        let response = await fetch('https://api.thankshell.com/dev/user/', {
            method: "GET",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                Authorization: session.idToken.jwtToken
            },
        });

        let userInfo = await response.json();

        if (userInfo.code == "SUCCESS") {
            let published = await getPublished(session);
            let holdersInfo = await getHolding(userInfo.name, session);
            let holding = holdersInfo['sla_bank'];

            $("#user-name").text(userInfo.name ? userInfo.name : '---');
            $("#published").text(published.toLocaleString());
            $("#carried").text(holding.toLocaleString());
            $("#currency").text((published - holding).toLocaleString());


            $("#admin-only").show();

            try {
                $('#carried-list').empty();
                let table = $('#account-info').DataTable();
                for(let holder in holdersInfo) {
                    if(holdersInfo[holder]) {
                        table.row.add( [
                            holder,
                            '--',
                            holdersInfo[holder],
                        ]).draw();
                    }
                };

                let history = await loadTransactions('sla_bank', session);

                $('#history').empty();
                history.forEach(record => {
                    $('<tr>')
                        .append($('<th scope="row" class="text-right">').text(record.transaction_id))
                        .append($('<td>').text(getTimeString(record.timestamp)))
                        .append($('<td>').text(record.from_account))
                        .append($('<td>').text(record.to_account))
                        .append($('<td class="text-right">').text(record.amount.toLocaleString()))
                        .append($('<td class="text-left">').text(record.comment ? record.comment : ''))
                        .appendTo('#history');
                });
            } catch(e) {
                $('#history-message').text('ERROR: ' + e.message);
            }

            $('#publish-button').click(function(){ publish(); });
            $('#send-selan-button').click(function() { sendSelan(); });
        } else {
            // TODO: implement register page
            location.href='/register';
        }

        console.log(userInfo);
    });
    </script>
  </body>
</html>
